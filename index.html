<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checks Issued</title>
  <style>
    /* Styling code remains the same */
  </style>
</head>
<body>

  <!-- Splash Screen -->
  <div id="splash">
    <div class="spinner"></div>
    <div class="loading-text">Loading data...</div>
  </div>

  <h1>PROVINCIAL GOVERNMENT OF BATANGAS</h1>
  <h2>Provincial Treasurer's Office - Cash Division<br>Checks Issued</h2>

  <!-- Last Update -->
  <div id="last-update" class="last-update">Last Update: N/A</div>

  <input type="text" id="search" placeholder="Search by OBR No., Payee, Particulars...">
  <ul id="sheet-data"></ul>

  <!-- Footer -->
  <footer>
    <p>
      Last repository update: <span id="last-updated">Loading...</span> | Data Size: <span id="data-size">Calculating...</span>
    </p>
  </footer>

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    // GitHub Last Updated (repo push date)
    (async () => {
      const user = "ptobatangascash";
      const repo = "rci";
      const url = `https://api.github.com/repos/${user}/${repo}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
        const data = await res.json();
        const pushedAt = new Date(data.pushed_at);
        const formatted = pushedAt.toLocaleString();
        document.getElementById("last-updated").textContent = formatted;
      } catch (err) {
        console.error("Failed to fetch last updated date:", err);
        document.getElementById("last-updated").textContent = "Unavailable";
      }
    })();

    const sheetUrl = "https://script.google.com/macros/s/AKfycbw0MDwN0hLe2sHbPU_XASvI8GH_4CKOTAVeW9ytPbUslPowl3v6L61P_pSfguWpH5HnNg/exec";
    const CLIENT_ID = 'ptobatangascash';
    const API_KEY = '886673521729-0olu0cqt676ffol6lkakim4kh1f4c0ti.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1wPU0y3wSdmSBzQbPyWQAXqMLDYxuKAd4FdYQ6WJ7d7g';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

    let gapiInited = false;
    let fullData = [];
    let downloadSize = 0;

    function renderList(data) {
      const list = document.getElementById("sheet-data");
      list.innerHTML = "";

      data.sort((a, b) => {
        const dateA = a.CheckDate ? new Date(a.CheckDate) : new Date(0);
        const dateB = b.CheckDate ? new Date(b.CheckDate) : new Date(0);
        return dateB - dateA;
      });

      data.forEach(item => {
        const li = document.createElement("li");

        let formattedDate = item.CheckDate;
        if (item.CheckDate) {
          const date = new Date(item.CheckDate);
          if (!isNaN(date)) {
            formattedDate = new Intl.DateTimeFormat('en-US', {
              year: 'numeric',
              month: 'long',
              day: '2-digit'
            }).format(date);
          }
        }

        let formattedAmount = item.Amount;
        if (item.Amount && !isNaN(item.Amount)) {
          formattedAmount = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(Number(item.Amount));
        }

        let dateCode = '';
        if (item.CheckDate) {
          const date = new Date(item.CheckDate);
          if (!isNaN(date)) {
            const year = date.getFullYear().toString().slice(2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            dateCode = `${year}${month}`;
          }
        }

        let rawDV = item.DV;
        let formattedDV = rawDV ? parseInt(rawDV).toString().padStart(6, '0') : '';

        if (formattedDV && item.Fund) {
          if (item.Fund === "General Fund") {
            formattedDV = `CK-100-${dateCode}-${formattedDV}`;
          } else if (item.Fund === "SEF") {
            formattedDV = `CK-200-${dateCode}-${formattedDV}`;
          } else if (item.Fund === "Trust Fund") {
            formattedDV = `CK-300-${dateCode}-${formattedDV}`;
          } else if (item.Fund === "SHF") {
            formattedDV = `CK-400-${dateCode}-${formattedDV}`;
          }
        }

        let statusColor = "";
        if (item.Status && ["For Release", "Released"].includes(item.Status.trim())) {
          statusColor = "color: green; font-weight: bold;";
        }
        if (item.Status && ["Check Printing Queue", "For Signature"].includes(item.Status.trim())) {
          statusColor = "color: red; font-weight: bold;";
        }

        li.innerHTML = `<strong>${item.Payee}</strong><br>Date: ${formattedDate}<br>Check Number: ${item.CheckNo}<br>OBR No.: ${item.OBR}<br>Voucher No.: ${formattedDV}<br>Net Amount: ${formattedAmount}<br>Status: <span style="${statusColor}">${(item.Status || "").toUpperCase()}</span><br>Office: ${item.Office}<br>Particulars: ${item.Nature}`;
        list.appendChild(li);
      });

      // Google API Client Initialization
      gapi.load('client:auth2', start);

      function start() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
        }).then(function () {
          gapiInited = true;
          checkAuth();
        });
      }

      function checkAuth() {
        gapi.auth2.getAuthInstance().isSignedIn.listen(handleAuthResult);
        handleAuthResult(gapi.auth2.getAuthInstance().isSignedIn.get());
      }

      function handleAuthResult(isSignedIn) {
        if (isSignedIn) {
          getSheetMetadata();
        } else {
          gapi.auth2.getAuthInstance().signIn();
        }
      }

      function getSheetMetadata() {
        gapi.client.sheets.spreadsheets.get({
          spreadsheetId: SPREADSHEET_ID,
        }).then(function(response) {
          const lastUpdated = response.result.properties.modifiedTime;
          const formattedLastUpdated = new Date(lastUpdated);
          const formattedDate = new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'long',
            day: '2-digit'
          }).format(formattedLastUpdated);
          
          // Display the last update date
          document.getElementById("last-update").textContent = `Last Update: ${formattedDate}`;
        });
      }
      
      function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
      }

      fetch(sheetUrl)
        .then(response => response.json())
        .then(data => {
          if (!Array.isArray(data)) {
            throw new Error("Invalid data format received from the Google Apps Script");
          }

          fullData = data;
          downloadSize = new TextEncoder().encode(JSON.stringify(data)).length;
          const downloadSizeMB = formatBytes(downloadSize);

          renderList(data);
          document.getElementById("data-size").textContent = downloadSizeMB;
          document.getElementById("splash").style.display = "none";
        })
        .catch(error => {
          console.error("Error loading sheet data:", error);
          document.getElementById("sheet-data").innerHTML = "<li>Error loading data</li>";
          document.getElementById("splash").style.display = "none";
        });

      // Search filter with debounce
      const searchInput = document.getElementById("search");
      searchInput.addEventListener("input", debounce(function () {
        const query = this.value.toLowerCase();
        const filtered = fullData.filter(item =>
          (item.OBR && item.OBR.toLowerCase().includes(query)) ||
          (item.Payee && item.Payee.toLowerCase().includes(query)) ||
          (item.Office && item.Office.toLowerCase().includes(query)) ||
          (item.Nature && item.Nature.toLowerCase().includes(query))
        );
        renderList(filtered);
      }, 300));

      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

    </script>

</body>
</html>
